name: Deploy Remix Application to HostIQ

on:
  push:
    branches:
      - main  # Замените на имя ветки, которую вы используете для развертывания

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'  # Укажите версию Node.js, требуемую для вашего проекта

    - name: Install dependencies
      run: npm install

    - name: Build
      run: npm run build  # Команда для сборки вашего приложения

    - name: Archive production artifacts
      run: tar -czf release.tar.gz ./*  # Архивирует собранные файлы

    - name: Deploy to HostIQ server via SSH
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOSTIQ_HOST }}
        username: ${{ secrets.HOSTIQ_USERNAME }}
        password: ${{ secrets.HOSTIQ_PASSWORD }}
        port: ${{ secrets.HOSTIQ_PORT }}
        source: "release.tar.gz"
        target: "/path/to/your/deployment/directory"
      
    - name: Execute remote SSH commands
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOSTIQ_HOST }}
        username: ${{ secrets.HOSTIQ_USERNAME }}
        password: ${{ secrets.HOSTIQ_PASSWORD }}
        port: ${{ secrets.HOSTIQ_PORT }}
        script: |
          cd /path/to/your/deployment/directory
          tar -xzf release.tar.gz  # Распаковывает архив
          npm install --production  # Устанавливает зависимости для продакшена
          pm2 restart all  # Перезапускает приложение через PM2 или любой другой менеджер процессов
